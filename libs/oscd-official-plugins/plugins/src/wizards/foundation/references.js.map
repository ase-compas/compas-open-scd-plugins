{"version":3,"file":"references.js","sourceRoot":"","sources":["../../../src/wizards/foundation/references.ts"],"names":[],"mappings":"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","sourcesContent":["import {\r\n  getNameAttribute,\r\n  isPublic,\r\n} from '@openscd/open-scd/src/foundation.js';\r\nimport {\r\n  Delete,\r\n  Replace\r\n} from '@openscd/core/foundation/deprecated/editor';\r\nconst referenceInfoTags = ['IED', 'Substation', 'VoltageLevel', 'Bay'] as const;\r\ntype ReferencesInfoTag = (typeof referenceInfoTags)[number];\r\n\r\ntype FilterFunction = (\r\n  element: Element,\r\n  attributeName: string | null,\r\n  oldName: string | null\r\n) => string;\r\n\r\n/*\r\n * For every supported tag a list of information about which elements to search for and which attribute value\r\n * to replace with the new value typed in the screen by the user. This is used to update references to a name\r\n * of an element by other elements.\r\n * If the attributeName is null the text content of the found element will be replaced.\r\n */\r\nconst referenceInfos: Record<\r\n  ReferencesInfoTag,\r\n  {\r\n    attributeName: string | null;\r\n    filter: FilterFunction;\r\n  }[]\r\n> = {\r\n  IED: [\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`Association`),\r\n    },\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`ClientLN`),\r\n    },\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`ConnectedAP`),\r\n    },\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`ExtRef`),\r\n    },\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`KDC`),\r\n    },\r\n    {\r\n      attributeName: 'iedName',\r\n      filter: simpleAttributeFilter(`LNode`),\r\n    },\r\n    {\r\n      attributeName: null,\r\n      filter: simpleTextContentFilter(`GSEControl > IEDName`),\r\n    },\r\n    {\r\n      attributeName: null,\r\n      filter: simpleTextContentFilter(`SampledValueControl > IEDName`),\r\n    },\r\n    {\r\n      attributeName: null,\r\n      filter: simpleTextContentFilter(`LN > DOI > DAI > Val`),\r\n    },\r\n  ],\r\n  Substation: [\r\n    {\r\n      attributeName: 'substationName',\r\n      filter: simpleAttributeFilter(`Terminal`),\r\n    },\r\n  ],\r\n  VoltageLevel: [\r\n    {\r\n      attributeName: 'voltageLevelName',\r\n      filter: attributeFilterWithParentNameAttribute(`Terminal`, {\r\n        Substation: 'substationName',\r\n      }),\r\n    },\r\n  ],\r\n  Bay: [\r\n    {\r\n      attributeName: 'bayName',\r\n      filter: attributeFilterWithParentNameAttribute(`Terminal`, {\r\n        Substation: 'substationName',\r\n        VoltageLevel: 'voltageLevelName',\r\n      }),\r\n    },\r\n  ],\r\n};\r\n\r\n/**\r\n * Simple function to create a filter to find Elements where the value of an attribute equals the old name.\r\n *\r\n * @param tagName - The tagName of the elements to search for.\r\n */\r\nfunction simpleAttributeFilter(tagName: string) {\r\n  return function filter(\r\n    element: Element,\r\n    attributeName: string | null,\r\n    oldName: string | null\r\n  ): string {\r\n    return `${tagName}[${attributeName}=\"${oldName}\"]`;\r\n  };\r\n}\r\n\r\n/**\r\n * Simple function to search for Elements for which the text content may contain the old name.\r\n * Because the text content of an element can't be search for in a CSS Selector this is done afterwards.\r\n *\r\n * @param elementQuery - The CSS Query to search for the Elements.\r\n */\r\nfunction simpleTextContentFilter(elementQuery: string) {\r\n  return function filter(): string {\r\n    return `${elementQuery}`;\r\n  };\r\n}\r\n\r\n/**\r\n * More complex function to search for elements for which the value of an attribute needs to be updated.\r\n * To find the correct element the name of a parent element also needs to be included in the search.\r\n *\r\n * For instance when the name of a Bay is updated only the terminals need to be updated where of course\r\n * the old name of the bay is the value of the attribute 'bayName', but also the voltage level and substation\r\n * name need to be included, because the name of the bay is only unique within the voltage level.\r\n * The query will then become\r\n * `Terminal[substationName=\"<substationName>\"][voltageLevelName=\"<voltageLevelName>\"][bayName=\"<oldName>\"]`\r\n *\r\n * @param tagName    - The tagName of the elements to search for.\r\n * @param parentInfo - The records of parent to search for, the key is the tagName of the parent, the value\r\n *                     is the name of the attribuet to use in the query.\r\n */\r\nfunction attributeFilterWithParentNameAttribute(\r\n  tagName: string,\r\n  parentInfo: Record<string, string>\r\n) {\r\n  return function filter(\r\n    element: Element,\r\n    attributeName: string | null,\r\n    oldName: string | null\r\n  ): string {\r\n    return `${tagName}${\r\n      Object.entries(parentInfo)\r\n        .map(([parentTag, parentAttribute]) => {\r\n          const parentElement = element.closest(parentTag);\r\n          if (parentElement && parentElement.hasAttribute('name')) {\r\n            const name = parentElement.getAttribute('name');\r\n            return `[${parentAttribute}=\"${name}\"]`;\r\n          }\r\n          return null;\r\n        })\r\n        .join('') // Join the strings to 1 string without a separator.\r\n    }[${attributeName}=\"${oldName}\"]`;\r\n  };\r\n}\r\n\r\n/**\r\n * Clone an element with the attribute name passed and process the new value. If the new value\r\n * is null the attribute will be removed otherwise the value of the attribute is updated.\r\n *\r\n * @param element       - The element to clone.\r\n * @param attributeName - The name of the attribute to copy.\r\n * @param value         - The value to set on the cloned element or if null remove the attribute.\r\n * @returns Returns the cloned element.\r\n */\r\nfunction cloneElement(\r\n  element: Element,\r\n  attributeName: string,\r\n  value: string\r\n): Element {\r\n  const newElement = <Element>element.cloneNode(false);\r\n  newElement.setAttribute(attributeName, value);\r\n  return newElement;\r\n}\r\n\r\n/**\r\n * Clone an element and set the value as text content on the cloned element.\r\n *\r\n * @param element - The element to clone.\r\n * @param value   - The value to set.\r\n * @returns Returns the cloned element.\r\n */\r\nfunction cloneElementAndTextContent(\r\n  element: Element,\r\n  value: string | null\r\n): Element {\r\n  const newElement = <Element>element.cloneNode(false);\r\n  newElement.textContent = value;\r\n  return newElement;\r\n}\r\n\r\n/**\r\n * Function to create Replace actions to update reference which point to the name of the element being updated.\r\n * For instance the IED Name is used in other SCL Elements as attribute 'iedName' to reference the IED.\r\n * These attribute values need to be updated if the name of the IED changes.\r\n *\r\n * An empty array will be returned if the old and new value are the same or no references need to be updated.\r\n *\r\n * @param element - The element for which the name is updated.\r\n * @param oldName - The old name of the element.\r\n * @param newName - The new name of the element.\r\n * @returns Returns a list of Replace Actions that can be added to a Complex Action or returned directly for execution.\r\n */\r\nexport function updateReferences(\r\n  element: Element,\r\n  oldName: string | null,\r\n  newName: string\r\n): Replace[] {\r\n  if (oldName === null || oldName === newName) {\r\n    return [];\r\n  }\r\n\r\n  const referenceInfo = referenceInfos[<ReferencesInfoTag>element.tagName];\r\n  if (referenceInfo === undefined) {\r\n    return [];\r\n  }\r\n\r\n  const actions: Replace[] = [];\r\n  referenceInfo.forEach(info => {\r\n    // Depending on if an attribute value needs to be updated or the text content of an element\r\n    // different scenarios need to be executed.\r\n    const filter = info.filter(element, info.attributeName, oldName);\r\n    if (info.attributeName) {\r\n      Array.from(element.ownerDocument.querySelectorAll(`${filter}`))\r\n        .filter(isPublic)\r\n        .forEach(element => {\r\n          const newElement = cloneElement(\r\n            element,\r\n            info.attributeName!,\r\n            newName\r\n          );\r\n          actions.push({ old: { element }, new: { element: newElement } });\r\n        });\r\n    } else {\r\n      // If the text content needs to be updated, filter on the text content can't be done in a CSS Selector.\r\n      // So we query all elements the may need to be updated and filter them afterwards.\r\n      Array.from(element.ownerDocument.querySelectorAll(`${filter}`))\r\n        .filter(element => element.textContent === oldName)\r\n        .filter(isPublic)\r\n        .forEach(element => {\r\n          const newElement = cloneElementAndTextContent(element, newName);\r\n          actions.push({ old: { element }, new: { element: newElement } });\r\n        });\r\n    }\r\n  });\r\n\r\n  if (element.tagName === 'IED')\r\n    actions.push(...updateVals(element, oldName, newName));\r\n  return actions;\r\n}\r\n\r\n/**\r\n * Adds Replace actions to update supervision references.\r\n * Only a maximum of one Val element per IED with ExtRef elements that contain src attributes will be altered.\r\n * The Val element that needs to be altered will be found by checking if the controlBlockReference complies with this element.\r\n * The controlBlockReference needs to contain the IED that gets renamed.\r\n *\r\n * @param element - The element for which the name is updated.\r\n * @param oldName - The old name of the element.\r\n * @param newName - The new name of the element.\r\n */\r\nfunction updateVals(element: Element, oldName: string | null, newName: string) {\r\n  const actions: Replace[] = [];\r\n  const ieds = element.ownerDocument.querySelectorAll('IED');\r\n  ieds.forEach(ied => {\r\n    // All Val elements inside LGOS and LSVS lnClasses that starts with the IED name that needs to be changed will be gathered.\r\n    // Because of a very rare case where multiple IED start with the same name, all will be gathered.\r\n    // If none are found continue to the next IED.\r\n    const valValues: Element[] = Array.from(\r\n      ied.querySelectorAll(\r\n        `:scope > AccessPoint > Server > LDevice > LN[lnClass=\"LGOS\"] > DOI > DAI > Val, :scope > AccessPoint > Server > LDevice > LN[lnClass=\"LSVS\"] > DOI > DAI > Val`\r\n      )\r\n    );\r\n\r\n    if (valValues.length === 0) return;\r\n\r\n    // If atleast one extRef element contains the to-be-changed IED name and has a srcCBName, one will be gathered.\r\n    // From that extRef element a controlblockreferences will be created and compared to the Val elements.\r\n    // If a match is found, the name of that Val element will be changed accordingly and the loop will be broken, as only 1 Val element need to be changed.\r\n\r\n    const ref = ied.querySelector(\r\n      `:scope > AccessPoint > Server > LDevice > LN0 > Inputs > ExtRef[iedName=\"${oldName}\"][srcCBName]`\r\n    );\r\n\r\n    const suffixCBReference =\r\n      ref?.getAttribute('srcLDInst') +\r\n      '/' +\r\n      ref?.getAttribute('srcLNClass') +\r\n      '.' +\r\n      ref?.getAttribute('srcCBName');\r\n\r\n    for (let value of valValues) {\r\n      if (oldName + suffixCBReference === value.textContent!.trim()) {\r\n        const newElement = cloneElementAndTextContent(\r\n          value,\r\n          newName + suffixCBReference\r\n        );\r\n        actions.push({\r\n          old: { element: value },\r\n          new: { element: newElement },\r\n        });\r\n        break;\r\n      }\r\n    }\r\n  });\r\n\r\n  return actions;\r\n}\r\n\r\n/**\r\n * Function to create Delete actions to remove reference which point to the name of the element being removed.\r\n * For instance the IED Name is used in other SCL Elements as attribute 'iedName' to reference the IED.\r\n * These elements need to be removed if the IED is removed.\r\n *\r\n * @param element - The element that will be removed and it's name is used to search for references.\r\n * @returns Returns a list of Delete Actions that can be added to a Complex Action or returned directly for execution.\r\n */\r\nexport function deleteReferences(element: Element): Delete[] {\r\n  const name = getNameAttribute(element) ?? null;\r\n  if (name === null) {\r\n    return [];\r\n  }\r\n\r\n  const referenceInfo = referenceInfos[<ReferencesInfoTag>element.tagName];\r\n  if (referenceInfo === undefined) {\r\n    return [];\r\n  }\r\n\r\n  const actions: Delete[] = [];\r\n  referenceInfo.forEach(info => {\r\n    // Depending on if an attribute value is used for filtering or the text content of an element\r\n    // different scenarios need to be executed.\r\n    const filter = info.filter(element, info.attributeName, name);\r\n    if (info.attributeName) {\r\n      Array.from(element.ownerDocument.querySelectorAll(`${filter}`))\r\n        .filter(isPublic)\r\n        .forEach(element => {\r\n          actions.push({ old: { parent: element.parentElement!, element } });\r\n        });\r\n    } else {\r\n      // If the text content needs to be used for filtering, filter on the text content can't be done in a CSS Selector.\r\n      // So we query all elements the may need to be deleted and filter them afterwards.\r\n      Array.from(element.ownerDocument.querySelectorAll(`${filter}`))\r\n        .filter(element => element.textContent === name)\r\n        .filter(isPublic)\r\n        .forEach(element => {\r\n          // We not only need to remove the element containing the text content, but the parent of this element.\r\n          if (element.parentElement) {\r\n            actions.push({\r\n              old: {\r\n                parent: element.parentElement.parentElement!,\r\n                element: element.parentElement,\r\n              },\r\n            });\r\n          }\r\n        });\r\n    }\r\n  });\r\n  return actions;\r\n}\r\n"]}